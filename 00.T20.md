# 1. 文档修订记录

|版本|修订日期|修订内容|修订人|
|---|---|---|---|
|V1.0|2025-03-03|初版发布|黄伟|

# 2. 概述

## 2.1 协议简介
* 本设备支持基于RS485物理层的Modbus RTU协议，协议标准为**Modbus Application Protocol v1.1b**
* 本设备为从机（Slave），响应主站（Master）的读/写请求

## 2.2 通信参数

|参数|默认值|说明|
|---|---|---|
|波特率|9600 bps|支持可配置（如4800/19200等）|
|数据位|8 bits||
|停止位|1 bit||
|校验方式|无校验|可选：无校验/奇校验/偶校验|
|设备地址|1~247|默认地址：1|
|响应超时|300 ms|主站等待从机响应的超时时间|

# 3. 物理层规范（RS485）

## 3.1 接口定义
|引脚|信号名称|说明|
|---|---|---|
|A|RS485+|差分信号正极|
|B|RS485-|差分信号负极|
|GND|地线|信号参考地|

## 3.2 电器特性
* 符合RS485 TIA/EIA-485标准。
* 最大传输距离：1200米（波特率≤19200时）。
* 终端电阻：建议在总线两端并联120Ω电阻。

# 4. 协议层规范（Modbus RTU）

## 4.1 数据帧格式
|字段|长度|说明|
|---|---|---|
|从机地址|1 Byte|设备地址范围1~247|
|功能码|1 Byte|操作类型（读/写）|
|数据域|N Bytes|寄存器地址、数据等|
|CRC校验|2 Bytes|循环冗余校验（低字节在前）|

## 4.2 支持的Modbus功能码
|功能码|名称|说明|
|---|---|---|
|0x03|Read Holding Registers|读取保持寄存器|
|0x04|Read Input Registers|读取输入寄存器|
|0x06|Write Single Register|写单个保持寄存器|
|0x10|Write Multiple Register|写多个保持寄存器|


# 5. 寄存器地址映射表

## 5.1 寄存器定义
|寄存器地址|数据类型|读写权限|名称|单位|范围|说明|
|---|---|---|---|---|---|---|

**注：**
* 寄存器地址为16进制，实际Modbus报文中使用十进制地址（例如0x0001对应报文地址0001）。

# 6. 通信示例

## 读取保持寄存器（功能码0x03）
* **主站请求**  
    **01 03 00 00 00 02 C4 0B**  
    含义：读取从机地址1，起始地址0x0000（0），2个寄存器的值。
* **从机响应**  
    **01 03 04 00 0A 00 14 8A 12**  
    含义：返回4个字节数据（0x000A = 10，0x0014 = 20）。

# 7. 错误处理

## 7.1 异常响应格式
|字段|长度|说明|
|---|---|---|
|从机地址|1 Byte|设备地址|
|异常功能码|1 Byte|原功能码 + 0x80|
|异常码|1 Byte|错误类型（见下表）|
|CRC校验|2 Byte|校验码|

## 7.2 异常码列表
|异常码|名称|原因|
|---|---|---|
|0x01|Illegal Function|不支持的功能码|
|0x02|Illegal Data Address|无效寄存器地址|
|0x03|Illegal Data Value|数据值超出设备允许范围|

# 8. 附录

## 8.1 CRC16校验计算（示例代码）

* python
``` python
def crc16_modbus(data):
    crc = 0xFFFF
    for byte in data:
        crc ^= byte
        for _ in range(8):
            if crc & 0x0001:
                crc >>= 1
                crc ^= 0xA001
            else:
                crc >>= 1
    return crc.to_bytes(2, 'little')
```

## 8.2 参考文档
* Modbus协议规范：https://modbus.org/specs.php
* RS485标准：TIA/EIA-485-A